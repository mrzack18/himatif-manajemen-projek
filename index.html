<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Proyek Himpunan v3 (Tailwind)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi custom untuk Tailwind CSS (opsional, tapi bagus untuk konsistensi)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans"', 'sans-serif', '"Apple Color Emoji"', '"Segoe UI Emoji"', '"Segoe UI Symbol"', '"Noto Color Emoji"']
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* Menambahkan sedikit transisi untuk pengalaman pengguna yang lebih baik */
        .task-card, .kanban-col {
            transition: all 0.2s ease-in-out;
        }
        .kanban-col.drag-over {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased">

    <div id="auth-container">
        <div class="min-h-screen flex flex-col sm:flex-row items-center justify-center gap-8 p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Login</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-slate-700">Username</label>
                        <input type="text" id="login-username" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
                </form>
            </div>
             <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Daftar Akun Baru</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="reg-username" class="block text-sm font-medium text-slate-700">Username</label>
                        <input type="text" id="reg-username" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="reg-password" class="block text-sm font-medium text-slate-700">Password</label>
                        <input type="password" id="reg-password" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="reg-role" class="block text-sm font-medium text-slate-700">Daftar sebagai</label>
                         <select id="reg-role" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="member">Member</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">Daftar</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <nav class="bg-slate-800 shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-white font-bold text-xl flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" /></svg>
                            Proyek Himpunan
                        </div>
                        <div class="hidden md:block">
                            <div id="nav-links" class="ml-10 flex items-baseline space-x-4">
                                </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-slate-300 text-sm" id="user-greeting"></span>
                        <button id="logout-btn" class="px-3 py-1.5 border border-red-500 text-red-500 rounded-md text-sm hover:bg-red-500 hover:text-white transition-colors">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
            <div id="dashboard-view">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Pilih Proyek:</h4>
                        <div class="flex flex-wrap gap-2" id="project-selector"></div>
                    </div>
                    <div class="flex-shrink-0 flex flex-wrap gap-2" id="manager-actions"></div>
                </div>
                
                <h3 id="project-title" class="text-2xl font-bold text-slate-800 mb-6"></h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="kanban-board">
                    <div>
                        <div class="bg-yellow-400 text-slate-900 font-bold p-3 rounded-t-lg flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                           To-Do
                        </div>
                        <div class="kanban-col bg-slate-200 p-4 rounded-b-lg min-h-[70vh] space-y-4" id="todo" ondragover="event.preventDefault()" ondrop="drop(event)" ondragleave="dragLeave(event)" ondragenter="dragEnter(event)"></div>
                    </div>
                    <div>
                         <div class="bg-blue-500 text-white font-bold p-3 rounded-t-lg flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991 0l-3.182-3.182a8.25 8.25 0 00-11.667 0l-3.181 3.182" /></svg>
                           In Progress
                        </div>
                        <div class="kanban-col bg-slate-200 p-4 rounded-b-lg min-h-[70vh] space-y-4" id="inprogress" ondragover="event.preventDefault()" ondrop="drop(event)" ondragleave="dragLeave(event)" ondragenter="dragEnter(event)"></div>
                    </div>
                    <div>
                         <div class="bg-green-500 text-white font-bold p-3 rounded-t-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
                            Completed
                        </div>
                        <div class="kanban-col bg-slate-200 p-4 rounded-b-lg min-h-[70vh] space-y-4" id="completed" ondragover="event.preventDefault()" ondrop="drop(event)" ondragleave="dragLeave(event)" ondragenter="dragEnter(event)"></div>
                    </div>
                </div>
            </div>

            <div id="admin-users-view" class="hidden">
                 <h3 class="text-2xl font-bold text-slate-800 mb-6">Manajemen User</h3>
                 <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Username</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Aksi</th></tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                 </div>
            </div>
            <div id="admin-projects-view" class="hidden">
                 <h3 class="text-2xl font-bold text-slate-800 mb-6">Manajemen Proyek</h3>
                 <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                     <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Nama Proyek</th><th class="px-6 py-3">Manager ID</th><th class="px-6 py-3">Aksi</th></tr>
                        </thead>
                        <tbody id="project-table-body"></tbody>
                    </table>
                 </div>
            </div>
        </main>
    </div>

    <div id="createProjectModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeModal('createProjectModal', event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b"><h5 class="text-xl font-bold text-slate-800">Buat Proyek Baru</h5></div>
            <div class="p-6">
                <form id="create-project-form" class="space-y-4">
                    <div>
                        <label for="project-name" class="block text-sm font-medium text-slate-700">Nama Proyek</label>
                        <input type="text" id="project-name" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Simpan</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="createTaskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeModal('createTaskModal', event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b"><h5 class="text-xl font-bold text-slate-800">Buat Tugas Baru</h5></div>
            <div class="p-6">
                <form id="create-task-form" class="space-y-4">
                     <div>
                        <label for="task-title" class="block text-sm font-medium text-slate-700">Judul Tugas</label>
                        <input type="text" id="task-title" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="task-desc" class="block text-sm font-medium text-slate-700">Deskripsi</label>
                        <textarea id="task-desc" rows="3" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Simpan</button>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteMemberModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeModal('inviteMemberModal', event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b"><h5 class="text-xl font-bold text-slate-800">Tambahkan Member</h5></div>
            <div class="p-6">
                 <form id="invite-member-form" class="space-y-4">
                    <div>
                        <label for="member-username" class="block text-sm font-medium text-slate-700">Username Member</label>
                        <input type="text" id="member-username" placeholder="Masukkan username yang sudah terdaftar" required class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Tambahkan</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // ===================================
        // MODAL HELPER FUNCTIONS (TAILWIND)
        // ===================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeModal(modalId, event) {
            const modal = document.getElementById(modalId);
             // Cek jika klik pada backdrop (elemen modal itu sendiri), bukan pada konten di dalamnya
            if (modal && (!event || event.target === modal)) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // ===================================
        // SCRIPT APLIKASI UTAMA (99% SAMA)
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            // ... (SEMUA KODE JS DARI STATE MANAGEMENT SAMPAI AKHIR) ...
            // CUKUP COPY-PASTE SEMUA KODE DARI <script> LAMA KE SINI,
            // KECUALI BAGIAN YANG AKAN DIMODIFIKASI DI BAWAH
        
             // STATE & LOCAL STORAGE MANAGEMENT (SAMA PERSIS)
            let state = { users: [], projects: [], tasks: [], currentUser: null, activeProjectId: null };
            function loadData() {
                const users = localStorage.getItem('users');
                const projects = localStorage.getItem('projects');
                const tasks = localStorage.getItem('tasks');
                state.users = users ? JSON.parse(users) : [];
                state.projects = projects ? JSON.parse(projects) : [];
                state.tasks = tasks ? JSON.parse(tasks) : [];
                if (state.users.length === 0) {
                    state.users.push({ id: 1, username: 'admin', password: 'admin', role: 'admin' });
                    saveData();
                }
            }
            function saveData() {
                localStorage.setItem('users', JSON.stringify(state.users));
                localStorage.setItem('projects', JSON.stringify(state.projects));
                localStorage.setItem('tasks', JSON.stringify(state.tasks));
            }
            
            // OTENTIKASI (SAMA PERSIS)
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const logoutBtn = document.getElementById('logout-btn');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const user = state.users.find(u => u.username === username && u.password === password);
                if (user) {
                    state.currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    initApp();
                } else {
                    alert('Username atau password salah!');
                }
            });
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                const role = document.getElementById('reg-role').value;
                if (state.users.some(u => u.username === username)) {
                    alert('Username sudah ada!');
                    return;
                }
                const newUser = { id: Date.now(), username, password, role };
                state.users.push(newUser);
                saveData();
                alert('Registrasi berhasil! Silakan login.');
                registerForm.reset();
            });
            logoutBtn.addEventListener('click', () => {
                state.currentUser = null;
                sessionStorage.removeItem('currentUser');
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            });

            // INISIALISASI APLIKASI (PERUBAHAN `d-none` menjadi `hidden`)
            function initApp() {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                renderUI();
            }
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                initApp();
            }

            // RENDER UI DINAMIS
            function renderUI() {
                renderNavbar();
                showView('dashboard-view');
                renderProjectSelector();
                const userProjects = getUserProjects();
                if (userProjects.length > 0) {
                    if (!state.activeProjectId || !userProjects.some(p => p.id === state.activeProjectId)) {
                       state.activeProjectId = userProjects[0].id;
                    }
                    renderKanbanBoard();
                } else {
                    document.getElementById('project-title').innerText = "Anda belum masuk ke proyek manapun.";
                    clearKanbanBoard();
                }
            }

            function renderNavbar() {
                const user = state.currentUser;
                document.getElementById('user-greeting').innerText = `Halo, ${user.username} (${user.role})`;
                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML = `<a href="#" onclick="showView('dashboard-view')" class="text-white bg-slate-900 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>`;
                if (user.role === 'admin') {
                    navLinks.innerHTML += `
                        <a href="#" onclick="showView('admin-users-view')" class="text-slate-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Manage Users</a>
                        <a href="#" onclick="showView('admin-projects-view')" class="text-slate-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Manage Projects</a>`;
                }
            }

            function renderProjectSelector() {
                const selector = document.getElementById('project-selector');
                const managerActions = document.getElementById('manager-actions');
                selector.innerHTML = '';
                managerActions.innerHTML = '';
                const userProjects = getUserProjects();
                userProjects.forEach(project => {
                    const btn = document.createElement('button');
                    // Style dinamis dihandle di renderKanbanBoard
                    btn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors'; 
                    btn.innerText = project.name;
                    btn.onclick = () => {
                        state.activeProjectId = project.id;
                        renderKanbanBoard();
                    };
                    selector.appendChild(btn);
                });
                if (state.currentUser.role === 'manager' || state.currentUser.role === 'admin') {
                     managerActions.innerHTML = `<button onclick="openModal('createProjectModal')" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> Buat Proyek</button>`;
                }
                if (state.activeProjectId && (state.currentUser.role === 'manager' || state.currentUser.role === 'admin')) {
                     managerActions.innerHTML += `
                        <button onclick="openModal('createTaskModal')" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md text-white bg-sky-500 hover:bg-sky-600"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> Buat Tugas</button>
                        <button onclick="openModal('inviteMemberModal')" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md text-white bg-slate-500 hover:bg-slate-600"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM2.5 13.5a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 003.75 18.5h12.5A2.75 2.75 0 0019 16v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H3.75A1.25 1.25 0 012.5 16v-2.5zM17 5.75a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" /></svg> Tambah Member</button>`;
                }
            }

            function renderKanbanBoard() {
                if (!state.activeProjectId) {
                    clearKanbanBoard();
                    document.getElementById('project-title').innerText = "Pilih atau buat sebuah proyek.";
                    return;
                }
                const project = state.projects.find(p => p.id === state.activeProjectId);
                document.getElementById('project-title').innerText = `Proyek: ${project.name}`;
                clearKanbanBoard();
                const todoCol = document.getElementById('todo');
                const inprogressCol = document.getElementById('inprogress');
                const completedCol = document.getElementById('completed');
                const projectTasks = state.tasks.filter(t => t.projectId === state.activeProjectId);
                projectTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    
                    let borderColor = 'border-blue-500'; // Default To-do
                    if (task.status === 'inprogress') borderColor = 'border-yellow-500';
                    if (task.status === 'completed') borderColor = 'border-green-500';
                    
                    taskCard.className = `task-card bg-white p-4 rounded-md shadow cursor-grab active:cursor-grabbing border-l-4 ${borderColor} ${task.status === 'completed' ? 'opacity-70' : ''}`;
                    taskCard.id = `task-${task.id}`;
                    taskCard.draggable = true;
                    taskCard.ondragstart = drag;
                    
                    const assigneeInfo = task.assignedTo 
                        ? `<div class="text-xs text-slate-500 mt-3 pt-2 border-t flex items-center gap-2">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM12.735 14c.618 0 1.093-.561.872-1.139a6.002 6.002 0 0 0-11.215 0c-.22.578.254 1.139.872 1.139h9.47Z" /></svg>
                               ${task.assignedTo}
                           </div>`
                        : '';

                    taskCard.innerHTML = `
                        <div class="font-bold text-slate-800">${task.title}</div>
                        <p class="text-sm text-slate-600 mt-1 ${task.status === 'completed' ? 'line-through' : ''}">${task.description}</p>
                        ${assigneeInfo}`;
                        
                    if (task.status === 'todo') todoCol.appendChild(taskCard);
                    else if (task.status === 'inprogress') inprogressCol.appendChild(taskCard);
                    else if (task.status === 'completed') completedCol.appendChild(taskCard);
                });
                
                // MODIFIKASI: Update class untuk tombol selector
                Array.from(document.getElementById('project-selector').children).forEach(btn => {
                    const project = getUserProjects().find(p => p.name === btn.innerText);
                    if(project && project.id === state.activeProjectId) {
                        btn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors bg-indigo-600 text-white';
                    } else {
                        btn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-indigo-600 border border-indigo-600 hover:bg-indigo-50';
                    }
                });
                renderProjectSelector(); // Panggil ulang untuk render tombol manager
            }

            function clearKanbanBoard() {
                document.getElementById('todo').innerHTML = '';
                document.getElementById('inprogress').innerHTML = '';
                document.getElementById('completed').innerHTML = '';
            }

            // MANAJEMEN PROYEK & TUGAS (MODIFIKASI: Menggunakan fungsi modal baru)
            document.getElementById('create-project-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('project-name').value;
                const newProject = { id: Date.now(), name, managerId: state.currentUser.id, memberIds: [state.currentUser.id] };
                state.projects.push(newProject);
                state.activeProjectId = newProject.id;
                saveData();
                renderUI();
                closeModal('createProjectModal');
                document.getElementById('create-project-form').reset();
            });
            document.getElementById('create-task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('task-title').value;
                const description = document.getElementById('task-desc').value;
                const newTask = { id: Date.now(), projectId: state.activeProjectId, title, description, status: 'todo', assignedTo: null };
                state.tasks.push(newTask);
                saveData();
                renderKanbanBoard();
                closeModal('createTaskModal');
                document.getElementById('create-task-form').reset();
            });
            document.getElementById('invite-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('member-username').value;
                const user = state.users.find(u => u.username === username);
                const project = state.projects.find(p => p.id === state.activeProjectId);
                if (!user) { alert('User tidak ditemukan!'); return; }
                if (project.memberIds.includes(user.id)) { alert('User sudah menjadi member proyek ini!'); return; }
                project.memberIds.push(user.id);
                saveData();
                alert(`${user.username} berhasil ditambahkan ke proyek!`);
                closeModal('inviteMemberModal');
                document.getElementById('invite-member-form').reset();
            });

            // LOGIKA DRAG & DROP (SAMA PERSIS, tapi dengan feedback visual baru dari CSS)
            window.drag = function(ev) { ev.dataTransfer.setData("text", ev.target.id); }
            window.drop = function(ev) {
                ev.preventDefault();
                const taskId = ev.dataTransfer.getData("text");
                const newStatus = ev.target.closest('.kanban-col').id;
                const task = state.tasks.find(t => `task-${t.id}` === taskId);
                if (task) {
                    task.status = newStatus;
                    if (newStatus === 'inprogress' && !task.assignedTo) {
                        task.assignedTo = state.currentUser.username;
                    }
                    saveData();
                    renderKanbanBoard();
                }
                dragLeave({target: ev.target.closest('.kanban-col')});
            }
            window.dragEnter = function(ev) { ev.target.closest('.kanban-col').classList.add('drag-over'); }
            window.dragLeave = function(ev) { ev.target.closest('.kanban-col').classList.remove('drag-over'); }

            // FUNGSI ADMIN (SAMA PERSIS, hanya HTML output disesuaikan)
            function renderAdminUsers() {
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';
                state.users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="px-6 py-4">${user.id}</td>
                        <td class="px-6 py-4 font-medium text-slate-900">${user.username}</td>
                        <td class="px-6 py-4">${user.role}</td>
                        <td class="px-6 py-4">
                            ${user.role !== 'admin' ? `<button class="font-medium text-red-600 hover:underline" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                        </td>`;
                    tbody.appendChild(tr);
                });
            }
            function renderAdminProjects() {
                const tbody = document.getElementById('project-table-body');
                tbody.innerHTML = '';
                state.projects.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="px-6 py-4">${p.id}</td>
                        <td class="px-6 py-4 font-medium text-slate-900">${p.name}</td>
                        <td class="px-6 py-4">${p.managerId}</td>
                        <td class="px-6 py-4">
                            <button class="font-medium text-red-600 hover:underline" onclick="deleteProject(${p.id})">Delete</button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }
            window.deleteUser = function(userId) {
                if (confirm('Yakin ingin menghapus user ini?')) {
                    state.users = state.users.filter(u => u.id !== userId);
                    saveData();
                    renderAdminUsers();
                }
            }
            window.deleteProject = function(projectId) {
                if (confirm('Yakin ingin menghapus proyek ini? Ini akan menghapus semua tugas di dalamnya.')) {
                    state.projects = state.projects.filter(p => p.id !== projectId);
                    state.tasks = state.tasks.filter(t => t.projectId !== projectId);
                    if(state.activeProjectId === projectId) state.activeProjectId = null;
                    saveData();
                    renderAdminProjects();
                    renderUI();
                }
            }

            // FUNGSI BANTUAN
            function getUserProjects() {
                if (!state.currentUser) return [];
                if (state.currentUser.role === 'admin') return state.projects;
                return state.projects.filter(p => p.memberIds.includes(state.currentUser.id));
            }
            window.showView = function(viewId) {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('admin-users-view').classList.add('hidden');
                document.getElementById('admin-projects-view').classList.add('hidden');
                const viewToShow = document.getElementById(viewId);
                if (viewToShow) viewToShow.classList.remove('hidden');
                if (viewId === 'admin-users-view') renderAdminUsers();
                if (viewId === 'admin-projects-view') renderAdminProjects();
            }

            loadData();
        });
    </script>

</body>
</html>
